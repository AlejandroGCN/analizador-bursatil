sequenceDiagram
    autonumber
    actor U as ðŸ‘¤ Usuario
    participant UI as ðŸ’» Streamlit
    participant BE as ðŸ–¥ï¸ Backend
    participant EX as ðŸ“ˆ DataExtractor
    participant REG as ðŸ“‹ Registry
    participant BP as ðŸ›ï¸ BaseProvider
    participant BA as ðŸ›ï¸ BaseAdapter
    participant API as ðŸŒ API Externa
    participant NORM as ðŸ§¹ Normalizer
    participant SER as ðŸ’¾ Series
    participant PORT as ðŸ’¼ Portfolio
    participant MC as ðŸŽ² MonteCarlo
    
    rect rgb(227, 242, 253)
        Note over U,BE: FASE 1: ExtracciÃ³n de Datos
        U->>UI: Selecciona sÃ­mbolos y fechas
        UI->>BE: ConfiguraciÃ³n
        BE->>EX: get_market_data()
    end
    
    rect rgb(200, 230, 201)
        Note over EX,REG: FASE 2: ResoluciÃ³n Provider
        EX->>REG: Resolver provider por fuente
        REG-->>EX: YahooProvider (ejemplo)
    end
    
    rect rgb(255, 243, 224)
        Note over EX,BP: FASE 3: Llamada Provider
        EX->>BP: get_symbols()
        Note over BP: BaseProvider.get_symbols()<br/>orquesta adapter + normalizer
    end
    
    rect rgb(252, 228, 236)
        Note over BP,BA: FASE 4: Descarga Adapter
        BP->>BA: adapter.get_symbols()
        Note over BA: BaseAdapter.get_symbols()<br/>descarga paralela con ThreadPool
        
        loop Para cada sÃ­mbolo
            BA->>BA: download_symbol()<br/>(YahooAdapter implementa)
            BA->>API: HTTP Request
            API-->>BA: Datos crudos<br/>(MultiIndex, JSON, etc.)
            BA->>BA: _finalize_ohlcv()<br/>NormalizaciÃ³n bÃ¡sica
        end
        
        BA-->>BP: Dict[str, DataFrame]<br/>Semi-normalizado
    end
    
    rect rgb(255, 249, 196)
        Note over BP,NORM: FASE 5: NormalizaciÃ³n Completa
        BP->>NORM: normalizer_tipology()
        
        Note over NORM: Pipeline 4 pasos:
        NORM->>NORM: 1. normalize_ohlcv()
        NORM->>NORM: 2. align_dict()
        NORM->>NORM: 3. apply_fill()
        NORM->>NORM: 4. build Series
        
        NORM->>SER: Crear PriceSeries, etc.
        SER-->>NORM: Objetos Series
        NORM-->>BP: Dict[str, Series]
        BP-->>EX: Datos completamente normalizados
    end
    
    rect rgb(243, 229, 245)
        Note over EX,PORT: FASE 6: AnÃ¡lisis Cartera
        EX-->>BE: Series Objects
        BE-->>UI: Datos para visualizaciÃ³n
        U->>UI: Configura cartera con pesos
        UI->>PORT: Portfolio(symbols, weights)
        PORT->>PORT: set_prices()<br/>Calcula retornos logarÃ­tmicos
        PORT->>PORT: portfolio_return()<br/>portfolio_volatility()<br/>sharpe_ratio()
    end
    
    rect rgb(232, 245, 233)
        Note over PORT,MC: FASE 7: SimulaciÃ³n Monte Carlo
        U->>UI: Ejecutar simulaciÃ³n
        UI->>PORT: monte_carlo_simulation()
        PORT->>MC: simulate_portfolio(return, vol)
        
        Note over MC: GBM: r = Î¼ + Ïƒ Ã— Z<br/>1000 simulaciones
        MC->>MC: Generar shocks aleatorios
        MC->>MC: Calcular trayectorias
        MC->>MC: Calcular percentiles
        
        MC-->>PORT: DataFrame simulaciones
        PORT-->>UI: Resultados + estadÃ­sticas
    end
    
    rect rgb(255, 248, 225)
        Note over UI,U: FASE 8: GeneraciÃ³n Reporte
        U->>UI: Solicitar reporte
        UI->>UI: MonteCarloReporter.generate()
        UI->>UI: Generar grÃ¡ficos matplotlib
        UI-->>U: Reporte MD + PNG
    end