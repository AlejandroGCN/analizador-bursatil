graph TB
    %% ============================================
    %% CAPA 1: USUARIO E INTERFAZ
    %% ============================================
    
    subgraph UI["ğŸ¨ Capa de PresentaciÃ³n"]
        direction TB
        Usuario["ğŸ‘¤ Usuario<br/><small>InteracciÃ³n</small>"]
        Dashboard["ğŸ’» Streamlit Dashboard<br/><small>4 PestaÃ±as: Datos | Cartera | Monte Carlo | Reporte</small>"]
        Backend["ğŸ–¥ï¸ Services Backend<br/><small>Orquestador UI â†” LÃ³gica</small>"]
        
        Usuario --> Dashboard
        Dashboard --> Backend
    end
    
    %% ============================================
    %% CAPA 2: FACADE Y REGISTRY
    %% ============================================
    
    subgraph Facade["âš™ï¸ Capa de ExtracciÃ³n (Facade)"]
        direction TB
        DataExtractor["ğŸ“ˆ DataExtractor<br/><small>ğŸ›ï¸ PatrÃ³n FACADE</small><br/><i>get_market_data()</i>"]
        Registry["ğŸ“‹ Provider Registry<br/><small>ğŸ“– PatrÃ³n REGISTRY</small><br/><i>{'yahoo': YahooProvider, ...}</i>"]
        
        DataExtractor --> Registry
    end
    
    Backend --> DataExtractor
    
    %% ============================================
    %% CAPA 3: PROVIDERS (CON HERENCIA)
    %% ============================================
    
    subgraph Providers["â˜ï¸ Capa de Providers"]
        direction TB
        
        subgraph ProvidersConcretos["Providers Concretos"]
            YahooP["ğŸŒ YahooProvider<br/><small>yahoo_provider.py</small>"]
            BinanceP["ğŸ’° BinanceProvider<br/><small>binance_provider.py</small>"]
            TiingoP["ğŸ“ˆ TiingoProvider<br/><small>tiingo_provider.py</small>"]
        end
        
        BaseProvider["ğŸ›ï¸ BaseProvider<br/><small>CLASE BASE</small><br/><i>get_symbols():<br/>  1. adapter.get_symbols()<br/>  2. normalizer_tipology()<br/>  3. return Series</i>"]
        
        YahooP -.hereda.-> BaseProvider
        BinanceP -.hereda.-> BaseProvider
        TiingoP -.hereda.-> BaseProvider
    end
    
    Registry --> YahooP
    Registry --> BinanceP
    Registry --> TiingoP
    
    %% ============================================
    %% CAPA 4: ADAPTERS (CON HERENCIA)
    %% ============================================
    
    subgraph Adapters["ğŸ”Œ Capa de Adaptadores"]
        direction TB
        
        subgraph AdaptersConcretos["Adaptadores Concretos"]
            YahooA["ğŸŒ YahooAdapter<br/><small>yahoo_adapter.py</small><br/><i>download_symbol()</i>"]
            BinanceA["ğŸ’° BinanceAdapter<br/><small>binance_adapter.py</small><br/><i>download_symbol()</i>"]
            TiingoA["ğŸ“ˆ TiingoAdapter<br/><small>tiingo_adapter.py</small><br/><i>download_symbol()</i>"]
        end
        
        BaseAdapter["ğŸ›ï¸ BaseAdapter<br/><small>CLASE BASE</small><br/><i>get_symbols():<br/>  - ThreadPoolExecutor<br/>  - download_symbol() x N<br/>  - _finalize_ohlcv()</i>"]
        
        YahooA -.hereda.-> BaseAdapter
        BinanceA -.hereda.-> BaseAdapter
        TiingoA -.hereda.-> BaseAdapter
    end
    
    YahooP --> YahooA
    BinanceP --> BinanceA
    TiingoP --> TiingoA
    
    %% ============================================
    %% CAPA 5: APIs EXTERNAS
    %% ============================================
    
    subgraph APIs["ğŸŒ APIs Externas"]
        direction LR
        YahooAPI["ğŸŒ Yahoo Finance API<br/><small>yfinance<br/>MultiIndex, Title Case</small>"]
        BinanceAPI["ğŸ’° Binance API<br/><small>REST API<br/>JSON, lowercase</small>"]
        TiingoAPI["ğŸ“ˆ Tiingo API<br/><small>REST JSON<br/>Calidad institucional<br/>70+ exchanges</small>"]
    end
    
    YahooA --> YahooAPI
    BinanceA --> BinanceAPI
    TiingoA --> TiingoAPI
    
    %% ============================================
    %% NORMALIZACIÃ“N
    %% ============================================
    
    subgraph Normalizacion["ğŸ§¹ Pipeline de NormalizaciÃ³n"]
        direction TB
        Normalizer["âš™ï¸ Normalizer<br/><small>normalizer.py</small><br/><i>normalizer_tipology():</i><br/>1ï¸âƒ£ normalize_ohlcv()<br/>2ï¸âƒ£ align_dict()<br/>3ï¸âƒ£ apply_fill()<br/>4ï¸âƒ£ build Series objects"]
        
        Nota1["ğŸ“ DOBLE NORMALIZACIÃ“N:<br/>â€¢ Nivel 1: BaseAdapter._finalize_ohlcv()<br/>â€¢ Nivel 2: Normalizer.normalizer_tipology()"]
    end
    
    BaseAdapter -.datos semi-normalizados.-> Normalizer
    BaseProvider --> Normalizer
    
    %% ============================================
    %% CAPA 6: SERIES (CON HERENCIA)
    %% ============================================
    
    subgraph Series["ğŸ’¾ Capa de Series de Datos"]
        direction TB
        
        subgraph SeriesConcretas["Series Concretas"]
            PriceSeries["ğŸ’° PriceSeries<br/><small>OHLCV data</small>"]
            PerfSeries["ğŸ“ˆ PerformanceSeries<br/><small>Returns data</small>"]
            VolSeries["ğŸ“Š VolatilitySeries<br/><small>Volatility data</small>"]
        end
        
        BaseSeries["ğŸ›ï¸ BaseSeries<br/><small>CLASE BASE</small><br/><i>symbol: str<br/>source: str<br/>data: DataFrame</i>"]
        
        PriceSeries -.hereda.-> BaseSeries
        PerfSeries -.hereda.-> BaseSeries
        VolSeries -.hereda.-> BaseSeries
    end
    
    Normalizer --> PriceSeries
    Normalizer --> PerfSeries
    Normalizer --> VolSeries
    
    %% ============================================
    %% CAPA 7: ANÃLISIS FINANCIERO
    %% ============================================
    
    subgraph Analisis["ğŸ“¦ Capa de AnÃ¡lisis Financiero"]
        direction TB
        Portfolio["ğŸ’¼ Portfolio<br/><small>portfolio.py</small><br/><i>set_prices()<br/>portfolio_return()<br/>portfolio_volatility()<br/>sharpe_ratio()</i>"]
        
        Validacion["ğŸ§± ValidaciÃ³n<br/><small>â€¢ Pesos = 1.0<br/>â€¢ No NaN<br/>â€¢ No infinitos</small>"]
        
        Portfolio --> Validacion
    end
    
    PriceSeries --> Portfolio
    PerfSeries --> Portfolio
    
    %% ============================================
    %% CAPA 8: SIMULACIÃ“N MONTE CARLO
    %% ============================================
    
    subgraph Simulacion["ğŸ² Capa de SimulaciÃ³n"]
        direction TB
        MonteCarlo["ğŸ² MonteCarloSimulation<br/><small>monte_carlo.py</small><br/><i>simulate_portfolio():</i><br/>ğŸ“ GBM: r = Î¼ + Ïƒ Ã— Z<br/>1000 simulaciones<br/>Percentiles 5%, 25%, 50%, 75%, 95%"]
        
        Logs["ğŸ“ Logs & Metrics<br/><small>ValidaciÃ³n matemÃ¡tica</small>"]
        
        MonteCarlo --> Logs
    end
    
    Validacion --> MonteCarlo
    
    %% ============================================
    %% CAPA 9: REPORTES Y VISUALIZACIÃ“N
    %% ============================================
    
    subgraph Reportes["ğŸ“„ Capa de Reportes"]
        direction TB
        Reporter["ğŸ“„ MonteCarloReporter<br/><small>monte_carlo_reporter.py</small><br/><i>Genera:<br/>â€¢ ComposiciÃ³n cartera<br/>â€¢ MÃ©tricas principales<br/>â€¢ AnÃ¡lisis de riesgo<br/>â€¢ Advertencias<br/>â€¢ Correlaciones</i>"]
        
        Graficos["ğŸ–¼ï¸ GrÃ¡ficos<br/><small>matplotlib/seaborn</small><br/><i>â€¢ EvoluciÃ³n precios<br/>â€¢ Trayectorias MC<br/>â€¢ Heatmap correlaciÃ³n<br/>â€¢ DistribuciÃ³n retornos</i>"]
        
        Reporter --> Graficos
    end
    
    MonteCarlo --> Reporter
    
    %% ============================================
    %% VUELTA AL USUARIO
    %% ============================================
    
    Graficos --> Dashboard
    Reporter --> Dashboard
    Dashboard --> Usuario
    
    %% ============================================
    %% ESTILOS
    %% ============================================
    
    classDef uiStyle fill:#E3F2FD,stroke:#1565C0,stroke-width:3px,color:#000
    classDef facadeStyle fill:#C8E6C9,stroke:#2E7D32,stroke-width:3px,color:#000
    classDef providerStyle fill:#FFF3E0,stroke:#E65100,stroke-width:2px,color:#000
    classDef adapterStyle fill:#FCE4EC,stroke:#C2185B,stroke-width:2px,color:#000
    classDef apiStyle fill:#FFEBEE,stroke:#C62828,stroke-width:2px,color:#000
    classDef normStyle fill:#FFF9C4,stroke:#F57F17,stroke-width:3px,color:#000
    classDef seriesStyle fill:#E0F2F1,stroke:#00695C,stroke-width:2px,color:#000
    classDef analysisStyle fill:#F3E5F5,stroke:#6A1B9A,stroke-width:3px,color:#000
    classDef simStyle fill:#E8F5E9,stroke:#388E3C,stroke-width:3px,color:#000
    classDef reportStyle fill:#FFF8E1,stroke:#FFA000,stroke-width:3px,color:#000
    classDef baseStyle fill:#EEEEEE,stroke:#424242,stroke-width:4px,stroke-dasharray: 5 5,color:#000,font-weight:bold
    classDef noteStyle fill:#FFFDE7,stroke:#F57F17,stroke-width:2px,color:#000,font-style:italic
    
    class Usuario,Dashboard,Backend uiStyle
    class DataExtractor,Registry facadeStyle
    class YahooP,BinanceP,TiingoP,ProvidersConcretos providerStyle
    class YahooA,BinanceA,TiingoA,AdaptersConcretos adapterStyle
    class YahooAPI,BinanceAPI,TiingoAPI apiStyle
    class Normalizer normStyle
    class PriceSeries,PerfSeries,VolSeries,SeriesConcretas seriesStyle
    class Portfolio,Validacion analysisStyle
    class MonteCarlo,Logs simStyle
    class Reporter,Graficos reportStyle
    class BaseProvider,BaseAdapter,BaseSeries baseStyle
    class Nota1 noteStyle
